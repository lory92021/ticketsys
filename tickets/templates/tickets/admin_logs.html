{% extends "base.html" %}

{% block content %}
<div class="container mt-4">

    <h2 class="mb-4">Log attività amministratore</h2>

    <!-- =========================
         ✅ FILTRI
    ========================== -->
    <div class="card shadow-sm mb-3 p-3">
        <form method="get" class="row g-2">

            <div class="col-md-2">
                <input type="text" name="admin" class="form-control"
                       placeholder="Admin"
                       value="{{ filters.admin }}">
            </div>

            <div class="col-md-2">
                <input type="text" name="target" class="form-control"
                       placeholder="Utente coinvolto"
                       value="{{ filters.target }}">
            </div>

            <div class="col-md-2">
                <input type="text" name="action" class="form-control"
                       placeholder="Azione"
                       value="{{ filters.action }}">
            </div>

            <div class="col-md-2">
                <input type="date" name="from" class="form-control"
                       value="{{ filters.from }}">
            </div>

            <div class="col-md-2">
                <input type="date" name="to" class="form-control"
                       value="{{ filters.to }}">
            </div>

            <div class="col-md-2 d-flex gap-2">
                <button class="btn btn-primary w-100">Filtra</button>
                <a href="{% url 'admin_logs' %}" class="btn btn-secondary w-100">Reset</a>
            </div>

        </form>
    </div>

    <!-- =========================
         ✅ TABELLA LOG
    ========================== -->
    <div class="card shadow-sm">
        <div class="card-body p-0">

            <table class="table table-striped table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>Data</th>
                        <th>Admin</th>
                        <th>Azione</th>
                        <th>Utente coinvolto</th>
                        <th>PRIMA → DOPO</th>
                        <th>Ticket</th>
                        <th>IP</th>
                    </tr>
                </thead>
                <tbody>

                {% for log in logs %}
                    <tr>

                        <td>{{ log.timestamp|date:"d/m/Y H:i" }}</td>

                        <td>
                            {% if log.actor %}
                                {{ log.actor.username }}
                            {% else %}
                                -
                            {% endif %}
                        </td>

                        <td>{{ log.action }}</td>

                        <td>
                            {% if log.target_user %}
                                {{ log.target_user.username }}
                            {% else %}
                                -
                            {% endif %}
                        </td>

                        <!-- ✅ PRIMA → DOPO -->
                        <td style="white-space: pre-line; max-width: 400px;">
                            {% if log.details %}
                                {{ log.details }}
                            {% else %}
                                -
                            {% endif %}
                        </td>

                        <td>
                            {% if log.ticket %}
                                <a href="{% url 'ticket_detail' log.ticket.id %}">
                                    #{{ log.ticket.id }}
                                </a>
                            {% else %}
                                -
                            {% endif %}
                        </td>

                        <td>{{ log.ip_address|default:"-" }}</td>
                    </tr>

                {% empty %}
                    <tr>
                        <td colspan="7" class="text-center text-muted p-3">
                            Nessun log presente.
                        </td>
                    </tr>
                {% endfor %}

                </tbody>
            </table>

        </div>
    </div>

</div>
{% endblock %}
